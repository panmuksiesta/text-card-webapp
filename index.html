<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡å­—å¡ç‰‡ç”¢ç”Ÿå™¨</title>

  <!-- è®“æ‰‹æ©Ÿç‰ˆå¥½æ“ä½œ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA è¨­å®š -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#f5f5f5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="æ–‡å­—å¡ç‰‡ç”¢ç”Ÿå™¨" />

  <!-- å¼•å…¥ html2canvasï¼Œç”¨ä¾†æŠŠé è¦½å€è½‰æˆåœ–ç‰‡ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans TC", "PingFang TC", sans-serif;
      background: #f5f5f5;
    }

    h1 {
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 900px) {
      .main {
        display: flex;
        gap: 1rem;
        align-items: stretch;
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 10px;
      padding: 0.75rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      padding: 0.5rem;
      font-size: 0.95rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      line-height: 1.5;
    }

    label {
      font-size: 0.85rem;
      color: #555;
    }

    select,
    button,
    input[type="file"] {
      font-size: 0.9rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .top-bar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    #fontSelect {
      padding: 0.25rem 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .emoji-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .emoji-button {
      border: none;
      border-radius: 6px;
      padding: 0.2rem 0.35rem;
      background: #f0f0f0;
      cursor: pointer;
      font-size: 1.1rem;
      transition: transform 0.05s ease, background 0.1s ease;
    }

    .emoji-button:active {
      transform: scale(0.96);
      background: #e0e0e0;
    }

    /* é è¦½å€ï¼šæœƒè¢«è½‰æˆåœ–ç‰‡çš„éƒ¨åˆ† */
    #previewWrapper {
      background: #e0e0e0;
      padding: 0.75rem;
      border-radius: 10px;
      overflow-x: auto;
    }

    #preview {
      margin: 0 auto;
      width: 100%;
      max-width: 600px;
      min-height: 250px;
      padding: 1.2rem;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #ddd;
      word-break: break-word;
      line-height: 1.6;
    }

    #previewText {
      white-space: pre-wrap;
      margin-bottom: 0.75rem;
    }

    #imageContainer img {
      max-width: 100%;
      display: block;
      margin-bottom: 0.5rem;
      border-radius: 8px;
    }

    .file-input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.5rem;
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 0.45rem 0.8rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-main {
      background: #4a90e2;
      color: #fff;
    }

    .btn-main:active {
      background: #3a78bf;
    }

    .btn-secondary {
      background: #eee;
      color: #333;
    }

    .btn-secondary:active {
      background: #ddd;
    }

    .note {
      font-size: 0.8rem;
      color: #777;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ–‡å­—å¡ç‰‡ç”¢ç”Ÿå™¨ï¼ˆæ–‡å­— âœ åœ–ç‰‡ï¼‰</h1>

    <!-- ä¸Šæ–¹å·¥å…·åˆ—ï¼šå­—å‹é¸æ“‡ -->
    <div class="panel">
      <div class="top-bar">
        <div class="top-bar-group">
          <label for="fontSelect">å­—å‹ï¼š</label>
          <select id="fontSelect">
            <option value='system-ui, -apple-system, "Noto Sans TC", sans-serif'>
              ç³»çµ±ç„¡è¥¯ç·šï¼ˆé è¨­ï¼‰
            </option>
            <option value='"PingFang TC", "Microsoft JhengHei", sans-serif'>
              è˜‹æ–¹ / å¾®è»Ÿæ­£é»‘
            </option>
            <option value='"Times New Roman", "Noto Serif TC", serif'>
              æœ‰è¥¯ç·šé¢¨æ ¼ï¼ˆTimesï¼‰
            </option>
            <option value='"Courier New", monospace'>
              æ‰“å­—æ©Ÿé¢¨æ ¼ï¼ˆç­‰å¯¬å­—ï¼‰
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="main">
      <!-- å·¦é‚Šï¼šæ–‡å­—ç·¨è¼¯å™¨ & è¡¨æƒ…ç¬¦è™Ÿ -->
      <div class="panel editor-panel">
        <div class="panel-title">1. æ–‡å­—ç·¨è¼¯å™¨</div>
        <textarea id="editor" placeholder="åœ¨é€™è£¡è¼¸å…¥ä½ æƒ³è¦çš„æ–‡å­—ï¼Œæ›è¡Œã€åŠ è¡¨æƒ…ã€ç­‰ç­‰ã€‚"></textarea>

        <div>
          <label>2. è¡¨æƒ…ç¬¦è™Ÿå°éµç›¤ï¼ˆé»ä¸€ä¸‹æœƒæ’å…¥åˆ°æ–‡å­—è£¡ï¼‰ï¼š</label>
          <div class="emoji-bar" id="emojiBar">
            <!-- ä¸€äº›å¸¸ç”¨è¡¨æƒ…ï¼Œå¯ä»¥ä¾å–œå¥½å†åŠ  -->
            <button type="button" class="emoji-button">ğŸ˜€</button>
            <button type="button" class="emoji-button">ğŸ˜‚</button>
            <button type="button" class="emoji-button">ğŸ¥¹</button>
            <button type="button" class="emoji-button">ğŸ˜Š</button>
            <button type="button" class="emoji-button">ğŸ˜</button>
            <button type="button" class="emoji-button">ğŸ˜</button>
            <button type="button" class="emoji-button">ğŸ¤”</button>
            <button type="button" class="emoji-button">ğŸ˜­</button>
            <button type="button" class="emoji-button">ğŸ¥³</button>
            <button type="button" class="emoji-button">â¤ï¸</button>
            <button type="button" class="emoji-button">ğŸ§¡</button>
            <button type="button" class="emoji-button">ğŸ’›</button>
            <button type="button" class="emoji-button">ğŸ’š</button>
            <button type="button" class="emoji-button">ğŸ’™</button>
            <button type="button" class="emoji-button">â­</button>
            <button type="button" class="emoji-button">âœ¨</button>
            <button type="button" class="emoji-button">ğŸŒˆ</button>
            <button type="button" class="emoji-button">ğŸ°</button>
            <button type="button" class="emoji-button">â˜•</button>
            <button type="button" class="emoji-button">ğŸ¶</button>
            <button type="button" class="emoji-button">ğŸ±</button>
          </div>
        </div>
      </div>

      <!-- å³é‚Šï¼šé è¦½å€ + åœ–ç‰‡æ’å…¥ + ä¸‹è¼‰ -->
      <div class="panel preview-panel">
        <div class="panel-title">3. æ–‡å­— + åœ–ç‰‡é è¦½å€ï¼ˆæœ€å¾Œæœƒè®Šæˆåœ–ç‰‡ï¼‰</div>

        <div id="previewWrapper">
          <div id="preview">
            <div id="previewText"></div>
            <div id="imageContainer"></div>
          </div>
        </div>

        <!-- æ’å…¥åœ–ç‰‡ -->
        <div class="file-input-row">
          <label for="imageInput">4. æ’å…¥åœ–ç‰‡ï¼š</label>
          <input type="file" id="imageInput" accept="image/*" multiple />
          <button type="button" class="btn btn-secondary" id="clearImagesBtn">
            æ¸…é™¤æ‰€æœ‰åœ–ç‰‡
          </button>
        </div>
        <div class="note">
          å°æé†’ï¼šæ’å…¥çš„æ˜¯ä½ æœ¬æ©Ÿçš„åœ–ç‰‡ï¼Œåªæœƒé¡¯ç¤ºåœ¨é€™å€‹ç¶²é è£¡ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚
        </div>

        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
        <div class="actions">
          <button type="button" class="btn btn-main" id="savePngBtn">
            å­˜æˆ PNG
          </button>
          <button type="button" class="btn btn-main" id="saveJpgBtn">
            å­˜æˆ JPG
          </button>
        </div>
        <div class="note">
          iPhone ä¸Šå¦‚æœæŒ‰äº†ä¸‹è¼‰åªæ˜¯æ‰“é–‹åœ–ç‰‡ï¼Œä¹Ÿå¯ä»¥é•·æŒ‰åœ–ç‰‡ âœ å„²å­˜åˆ°ç›¸ç°¿ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    // Service Worker è¨»å†Šï¼ˆéœ€è¦åœ¨ https ç¶²ç«™æˆ– localhost ä¸Šæ‰æœƒç”Ÿæ•ˆï¼‰
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => console.error("SW registration failed", err));
      });
    }

    const editor = document.getElementById("editor");
    const previewText = document.getElementById("previewText");
    const imageInput = document.getElementById("imageInput");
    const imageContainer = document.getElementById("imageContainer");
    const fontSelect = document.getElementById("fontSelect");
    const preview = document.getElementById("preview");

    const savePngBtn = document.getElementById("savePngBtn");
    const saveJpgBtn = document.getElementById("saveJpgBtn");
    const clearImagesBtn = document.getElementById("clearImagesBtn");

    // æ–‡å­—æ›´æ–° âœ å³æ™‚åæ˜ åˆ°é è¦½å€
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function updatePreview() {
      const text = editor.value;
      previewText.innerHTML = escapeHtml(text).replace(/\n/g, "<br>");
    }

    editor.addEventListener("input", updatePreview);
    updatePreview();

    // è¡¨æƒ…ç¬¦è™ŸæŒ‰éˆ•ï¼šæ’å…¥åˆ°æ–‡å­—ç·¨è¼¯å™¨
    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + text + after;

      const newPos = start + text.length;
      textarea.selectionStart = textarea.selectionEnd = newPos;
      textarea.focus();
      updatePreview();
    }

    document.getElementById("emojiBar").addEventListener("click", (e) => {
      if (e.target.classList.contains("emoji-button")) {
        const emoji = e.target.textContent;
        insertAtCursor(editor, emoji);
      }
    });

    // å­—å‹åˆ‡æ›
    fontSelect.addEventListener("change", () => {
      const fontFamily = fontSelect.value;
      editor.style.fontFamily = fontFamily;
      preview.style.fontFamily = fontFamily;
    });

    // æ’å…¥åœ–ç‰‡ï¼ˆæœ¬æ©Ÿï¼‰
    imageInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      files.forEach((file) => {
        if (!file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement("img");
          img.src = event.target.result;
          imageContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      });

      imageInput.value = "";
    });

    // æ¸…é™¤æ‰€æœ‰åœ–ç‰‡
    clearImagesBtn.addEventListener("click", () => {
      imageContainer.innerHTML = "";
    });

    // æŠŠé è¦½å€è½‰æˆåœ–ç‰‡ä¸¦ä¸‹è¼‰
    function downloadPreviewAsImage(type) {
      const format = type === "jpeg" ? "image/jpeg" : "image/png";
      const filename = `card-${Date.now()}.${type === "jpeg" ? "jpg" : "png"}`;

      html2canvas(preview, {
        backgroundColor: "#ffffff",
        scale: 2,
      }).then((canvas) => {
        const dataUrl =
          format === "image/jpeg"
            ? canvas.toDataURL("image/jpeg", 0.95)
            : canvas.toDataURL("image/png");

        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = filename;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    savePngBtn.addEventListener("click", () => downloadPreviewAsImage("png"));
    saveJpgBtn.addEventListener("click", () => downloadPreviewAsImage("jpeg"));
  </script>
</body>
</html>
